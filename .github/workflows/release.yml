name: Firmware Release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
          key: ${{ runner.os }}-pio

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO Core
        run: pip install --upgrade platformio

      - name: Get Release Version
        id: get_version
        run: |
          VERSION=${GITHUB_REF##*/}  # Extract the tag name from GITHUB_REF
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_ENV  # Set the version as an environment variable

      - name: Run PlatformIO
        env:
          VERSION: ${{ env.version }}  # Use the version from the environment variable
        run: pio run

      - name: Install rename
        run: sudo apt-get update && sudo apt-get install -y rename  # rename 패키지 설치

      - name: Rename bin files
        run: |
          echo "Renaming bin files with the environment name"
          find .pio/build/*/*.bin -exec rename 's:/:-:g' {} \;

      - name: Create toDeploy directory
        run: mkdir toDeploy

      - name: Remove .pio-build- prefix from bin files
        run: rename 's/.pio-build-//' ./*.bin

      - name: Replace space with underscore in folder names
        run: |
          echo "Replacing space by _ in folder names"
          find lib -type d -name "* *" | while read FNAME; do mv "$FNAME" "${FNAME// /_}"; done

      - name: Zip libraries per board
        run: |
          echo "Zipping libraries per board"
          if [ -d lib ]; then  # Check if the lib directory exists
            for dir in lib/*/; do
              if [ -d "$dir" ]; then  # Check if the subdirectory exists
                zip -r "${dir%/}-libraries.zip" "$dir"
              fi
            done
            mv lib/*.zip toDeploy
          else
            echo "No 'lib' directory found."
          fi

      - name: Remove unnecessary binaries and zips
        run: |
          echo "Removing unnecessary binaries and zips"
          rm -f *-all*.bin *-test*.bin *-test*.zip

      - name: Zip source code
        run: |
          echo "Zipping source code"
          zip -r Sources.zip src
          mv Sources.zip toDeploy
          mv *.bin toDeploy

      - name: List toDeploy contents
        run: ls -lA toDeploy

      - name: Upload Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: toDeploy/**
          
      - name: Finalize Release
        uses: softprops/action-gh-release@v1
        with:
          files: toDeploy/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
